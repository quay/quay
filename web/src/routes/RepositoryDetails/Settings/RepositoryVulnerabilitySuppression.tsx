import {AxiosError} from 'axios';
import {useRecoilValue, useSetRecoilState} from 'recoil';
import {AlertVariant} from 'src/atoms/AlertState';
import {
  SecurityDetailsCallStates,
  securityDetailsCallStatesInverter,
} from 'src/atoms/SecurityDetailsState';
import VulnerabilitySuppressionInput from 'src/components/VulnerabilitySuppressionInput';
import {useAlerts} from 'src/hooks/UseAlerts';
import {useRepositoryVulnerabilitySuppressions} from 'src/hooks/UseVulnerabilitySuppressions';
import {addDisplayError} from 'src/resources/ErrorHandling';
import {RepositoryDetails} from 'src/resources/RepositoryResource';

export default function RepositoryVulnerabilitySuppression(
  props: RepositoryVulnerabilitySuppressionProps,
) {
  const securityDetailsCallStates = useRecoilValue(SecurityDetailsCallStates);
  const resetSecurityDetailsCalls = useSetRecoilState(
    securityDetailsCallStatesInverter(securityDetailsCallStates),
  );
  const {addAlert} = useAlerts();

  const {
    setSuppressions: updateVulnerabilitySuppressions,
    loading: loadingSetSuppressions,
  } = useRepositoryVulnerabilitySuppressions({
    org: props.org,
    repo: props.repo,
    onSuccess: () => {
      addAlert({
        variant: AlertVariant.Success,
        title: 'Successfully updated vulnerability suppressions',
      });

      resetSecurityDetailsCalls([true]);
    },
    onError: (error: AxiosError) => {
      addAlert({
        variant: AlertVariant.Failure,
        title: addDisplayError(
          'Unable to update vulnerability suppressions',
          error,
        ),
      });
    },
  });

  return (
    <VulnerabilitySuppressionInput
      suppressedVulnerabilities={
        props.repoDetails.suppressed_vulnerabilities
          ? props.repoDetails.suppressed_vulnerabilities
          : []
      }
      mutator={updateVulnerabilitySuppressions}
      loading={loadingSetSuppressions}
      helperText='Specify vulnerability identifiers to suppress for any image in this repository. For example "CVE-2021-44228". They will match any vulnerability identifier that contains the specified string. You can also paste space or comma separated values. Any suppression defined here will be applied to all images in this repository.'
    />
  );
}

interface RepositoryVulnerabilitySuppressionProps {
  org: string;
  repo: string;
  repoDetails: RepositoryDetails;
}
