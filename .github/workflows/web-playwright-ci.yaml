name: Playwright E2E Tests
on:
  pull_request:
    branches:
      - "*"
    paths:
      - "web/**"
      - ".github/workflows/web-playwright-ci.yaml"

jobs:
  playwright:
    name: Playwright E2E Tests
    runs-on: quay-001-large-ubuntu-24-x64
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Quay image
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: localhost/quay-local:latest

      - name: Start Quay
        run: |
          docker compose up -d redis quay-db
          docker exec -t quay-db bash -c 'while ! pg_isready; do echo "waiting for postgres"; sleep 2; done'
          DOCKER_USER="1001:0" docker compose up -d --no-build quay

      - name: Wait for Quay to be ready
        run: |
          docker restart quay-quay
          echo "Waiting for Quay to be ready..."
          if curl -sf --retry 60 --retry-delay 2 --retry-all-errors \
              http://localhost:8080/health/instance > /dev/null 2>&1; then
            echo "Quay is ready!"
          else
            echo "Quay failed to become ready within 120 seconds"
            exit 1
          fi

      - name: Set up Node.js with npm caching
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: cd web && npm install

      - name: Get Playwright version
        id: playwright-version
        run: |
          cd web
          PLAYWRIGHT_VERSION=$(node -e "console.log(require('./package-lock.json').packages['node_modules/@playwright/test'].version)")
          echo "version=$PLAYWRIGHT_VERSION" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ steps.playwright-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: cd web && npx playwright install --with-deps

      - name: Install Playwright OS dependencies only
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: cd web && npx playwright install-deps

      - name: Run Playwright tests
        run: cd web && npm run test:e2e

      - name: Save PR number
        if: always()
        run: |
          mkdir -p ./pr-info
          echo ${{ github.event.pull_request.number }} > ./pr-info/pr_number.txt

      - name: Upload PR info
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-info
          path: pr-info/
          retention-days: 1

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: web/playwright-report/
          retention-days: 30

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-test-results
          path: web/test-results/
          retention-days: 30

      - name: Create debugging logs
        run: |
          mkdir -p logs/
          docker ps -a >logs/container-status.txt 2>&1 || true
          docker logs quay-quay >logs/quay.log 2>&1 || true
          docker logs quay-db >logs/quay-db.log 2>&1 || true
          docker logs quay-redis >logs/redis.log 2>&1 || true
        if: failure()

      - name: Upload debugging artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-debug
          path: logs/
          retention-days: 30
