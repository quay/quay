name: Frontend
on:
  push:
    branches:
    - "!dependabot/*"
    - "*"
    paths:
    - 'web/**'
    - 'endpoints/**'  # API changes affect frontend
    - 'auth/**'  # Auth changes affect frontend
    - 'data/**'  # Data layer changes may affect API responses
    - '.github/workflows/frontend.yaml'
  pull_request:
    branches:
    - "*"
    paths:
    - 'web/**'
    - 'endpoints/**'  # API changes affect frontend
    - 'auth/**'  # Auth changes affect frontend
    - 'data/**'  # Data layer changes may affect API responses
    - '.github/workflows/frontend.yaml'

jobs:
  cypress:
    name: Cypress Tests
    runs-on: ubuntu-22.04
    steps:

    - name: Checkout
      uses: actions/checkout@v6

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Docker Build
      env:
       DOCKER_BUILDKIT: 1
      run: docker build -t localhost/quay-local:latest .

    - name: Start Quay
      run: |
        docker compose up -d redis quay-db
        docker exec -t quay-db bash -c 'while ! pg_isready; do echo "waiting for postgres"; sleep 2; done'
        DOCKER_USER="1001:0" docker compose up -d --no-build quay

    - name: Seed Database
      run: cd web && npm run quay:seed

    - name: Set up Python 3.12
      uses: actions/setup-python@v6
      with:
        python-version: 3.12
        cache: 'pip'
        cache-dependency-path: requirements-dev.txt

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest requests

    - name: Integration Test
      run:  |
        docker restart quay-quay
        sleep 30
        make integration-test

    - name: Apply extra config options
      run:  |
        cat web/cypress/test/extra-config.yaml >> local-dev/stack/config.yaml
        docker restart quay-quay
        sleep 30

    - name: Set up Node.js with npm caching
      uses: actions/setup-node@v6
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: web/package-lock.json

    - name: Cypress run
      uses: cypress-io/github-action@v6
      with:
        browser: chrome
        build: npm run build
        start: npm run start:integration
        wait-on: 'http://localhost:9000'
        wait-on-timeout: 120
        working-directory: web
      env:
        REACT_QUAY_APP_API_URL: http://localhost:8080

    - name: Save PR number
      if: always() && github.event_name == 'pull_request'
      run: |
        mkdir -p ./test-results
        echo ${{ github.event.pull_request.number }} > ./test-results/pr_number.txt

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always() && github.event_name == 'pull_request'
      with:
        name: test-results
        path: |
          web/cypress/reports/ctrf-report.json
          test-results/pr_number.txt

    - name: Create report
      run: |
        mkdir -p logs/
        docker ps -a >logs/container-status.txt 2>&1 || true
        docker logs quay-quay >logs/quay.log 2>&1 || true
        docker logs quay-db >logs/quay-db.log 2>&1 || true
        docker logs quay-redis >logs/redis.log 2>&1 || true
      if: failure()

    - name: Upload debugging artifacts
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: cypress-debug
        path: |
          web/cypress/screenshots
          web/cypress/videos
          logs/

  frontend-plugin:
    name:  Build Frontend Plugin
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout
      uses: actions/checkout@v6

    - name: Set up Node.js with npm caching
      uses: actions/setup-node@v6
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: web/package-lock.json

    - name: Install dependencies
      run: cd web && npm install

    - name: Build plugin
      run: cd web && npm run build-plugin

  surge-preview-build:
    name: Surge Preview Build
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v6

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '22'
        cache: 'npm'
        cache-dependency-path: 'web/package-lock.json'

    - name: Install dependencies
      run: cd web && npm install

    - name: Build with mocked API
      run: cd web && npm run build
      env:
        MOCK_API: 'true'

    - name: Setup Surge for SPA routing
      run: |
        cd web/dist
        cp index.html 200.html

    - name: Save PR number
      if: success()
      run: |
        mkdir -p ./preview-build
        echo ${{ github.event.pull_request.number }} > ./preview-build/pr_number.txt

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: preview-build
        path: |
          web/dist/
          preview-build/pr_number.txt

  all-green:
    name: All Green
    if: always()
    needs: [cypress, frontend-plugin, surge-preview-build]
    runs-on: ubuntu-latest
    steps:
      - name: Check all jobs passed
        uses: re-actors/alls-green@release/v1
        with:
          allowed-skips: surge-preview-build
          jobs: ${{ toJSON(needs) }}
